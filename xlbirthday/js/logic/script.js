(function($){var touch={},touchTimeout,tapTimeout,swipeTimeout,longTapTimeout,longTapDelay=750,gesture;function swipeDirection(x1,x2,y1,y2){return Math.abs(x1-x2)>=Math.abs(y1-y2)?(x1-x2>0?"Left":"Right"):(y1-y2>0?"Up":"Down")}function longTap(){longTapTimeout=null;if(touch.last&&touch.el){touch.el.trigger("longTap");touch={}}}function cancelLongTap(){if(longTapTimeout){clearTimeout(longTapTimeout)}longTapTimeout=null}function cancelAll(){if(touchTimeout){clearTimeout(touchTimeout)}if(tapTimeout){clearTimeout(tapTimeout)}if(swipeTimeout){clearTimeout(swipeTimeout)}if(longTapTimeout){clearTimeout(longTapTimeout)}touchTimeout=tapTimeout=swipeTimeout=longTapTimeout=null;touch={}}function isPrimaryTouch(event){return(event.pointerType=="touch"||event.pointerType==event.MSPOINTER_TYPE_TOUCH)&&event.isPrimary}function isPointerEventType(e,type){return(e.type=="pointer"+type||e.type.toLowerCase()=="mspointer"+type)}$(document).ready(function(){var now,delta,deltaX=0,deltaY=0,firstTouch,_isPointerType;if("MSGesture" in window){gesture=new MSGesture();gesture.target=document.body}$(document).bind("MSGestureEnd",function(e){var swipeDirectionFromVelocity=e.velocityX>1?"Right":e.velocityX<-1?"Left":e.velocityY>1?"Down":e.velocityY<-1?"Up":null;if(swipeDirectionFromVelocity&&touch.el){touch.el.trigger("swipe");touch.el.trigger("swipe"+swipeDirectionFromVelocity)}}).on("touchstart MSPointerDown pointerdown",function(e){if((_isPointerType=isPointerEventType(e,"down"))&&!isPrimaryTouch(e)){return}firstTouch=_isPointerType?e:e.touches[0];if(e.touches&&e.touches.length===1&&touch.x2){touch.x2=undefined;touch.y2=undefined}now=Date.now();delta=now-(touch.last||now);touch.el=$("tagName" in firstTouch.target?firstTouch.target:firstTouch.target.parentNode);touchTimeout&&clearTimeout(touchTimeout);touch.x1=firstTouch.pageX;touch.y1=firstTouch.pageY;if(delta>0&&delta<=250){touch.isDoubleTap=true}touch.last=now;longTapTimeout=setTimeout(longTap,longTapDelay);if(gesture&&_isPointerType){gesture.addPointer(e.pointerId)}}).on("touchmove MSPointerMove pointermove",function(e){if((_isPointerType=isPointerEventType(e,"move"))&&!isPrimaryTouch(e)){return}firstTouch=_isPointerType?e:e.touches[0];cancelLongTap();touch.x2=firstTouch.pageX;touch.y2=firstTouch.pageY;deltaX+=Math.abs(touch.x1-touch.x2);deltaY+=Math.abs(touch.y1-touch.y2)}).on("touchend MSPointerUp pointerup",function(e){if((_isPointerType=isPointerEventType(e,"up"))&&!isPrimaryTouch(e)){return}cancelLongTap();if((touch.x2&&Math.abs(touch.x1-touch.x2)>30)||(touch.y2&&Math.abs(touch.y1-touch.y2)>30)){swipeTimeout=setTimeout(function(){if(touch.el){touch.el.trigger("swipe");touch.el.trigger("swipe"+(swipeDirection(touch.x1,touch.x2,touch.y1,touch.y2)));touch={}}},0)}else{if("last" in touch){if(deltaX<30&&deltaY<30){tapTimeout=setTimeout(function(){var event=$.Event("tap");event.cancelTouch=cancelAll;if(touch.el){touch.el.trigger(event)}if(touch.isDoubleTap){if(touch.el){touch.el.trigger("doubleTap")}touch={}}else{touchTimeout=setTimeout(function(){touchTimeout=null;if(touch.el){touch.el.trigger("singleTap")}touch={}},250)}},0)}else{touch={}}}}deltaX=deltaY=0}).on("touchcancel MSPointerCancel pointercancel",cancelAll);$(window).on("scroll",cancelAll)});["swipe","swipeLeft","swipeRight","swipeUp","swipeDown","doubleTap","tap","singleTap","longTap"].forEach(function(eventName){$.fn[eventName]=function(callback){return this.on(eventName,callback)}})})(Zepto);var Main={winHeight:0,winWidth:0,page:null,timer:null,myScroll:null,bindEvent:function(){var _this=this;_this.myScroll=new IScroll("#main",{snap:true,hScroll:false,momentum:false,hideScrollbar:true,});_this.myScroll.on("scrollEnd",function(){Main.updateView(_this.myScroll.currentPage.pageY)});$(".page-mark").tap(function(){$(this).addClass("hide");Main.updateView(_this.myScroll.currentPage.pageY)})},updateView:function(index){var _this=this;_this.page.removeClass("animation-on");_this.page.eq(index).addClass("animation-on");if(index==3){clearInterval(_this.timer);var item=_this.page.children(".page-3-wrap-0");var pic=$(".page-3-wrap-1  img");if(item.length>0){var sitem=$(item[0]);item.removeClass("page-3-wrap-fadeIn");pic.removeClass("page-3-wrap-fadeIn");sitem.addClass("page-3-wrap-fadeIn");_this.timer=setInterval(function(){item.removeClass("page-3-wrap-fadeIn");pic.removeClass("page-3-wrap-fadeIn");if(sitem.next(".page-3-wrap-0").length>0&&(sitem.next().next().length>0)){sitem=sitem.next();sitem.addClass("page-3-wrap-fadeIn")}else{item.removeClass("page-3-wrap-fadeIn");clearInterval(_this.timer);if(pic.length>0){var itemPic=$(pic[0]);itemPic.addClass("page-3-wrap-fadeIn");_this.timer=setInterval(function(){pic.removeClass("page-3-wrap-fadeIn");if(itemPic.next("img").length>0){console.log("haha");itemPic=itemPic.next();itemPic.addClass("page-3-wrap-fadeIn")}else{clearInterval(_this.timer);itemPic.addClass("page-3-wrap-fadeIn")}},1500)}}},2000)}}},sendMessage:function(){function filter(str){str=str.replace(/<\/?[^>]*>/g,"");str=str.replace(/[ | ]*\n/g,"\n");
str=str.replace(/&nbsp;/ig,"");return str}function send(name,text){var name=filter(name);var str=filter(text);$.ajax({url:"http://fancylin.sinaapp.com/message.php",async:false,type:"post",dataType:"text",data:{"message":str,"name":name}})}$("#send-btn").tap(function(){setTimeout(function(){$(".plane-front").removeClass("front");$(".plane-back").removeClass("back");$(".curvable").addClass("curved");setTimeout(function(){$(".plane-back").addClass("hover");setTimeout(function(){$(".plane-back").addClass("fly_away_first");setTimeout(function(){$(".plane-back").addClass("fly_away");setTimeout(function(){var str=$(".plane-message").val();var name=$(".plane-name").val();$(".plane-message").val("");$(".plane-name").val("");send(name,str);$(".plane-front").addClass("front");$(".plane-back").removeClass("fly_away fly_away_first hover").addClass("back");$(".curvable").removeClass("curved")},3000)},600)},2000)},2800)},200)})},makeBg:function(){$(".main").easyBackground({wrapNeighbours:false,overlay:false,baseColor:"#eee",colors:["#f9f6a4","#cbe1ec","#f5dfe2"],})},play:function(){getSong();function getSong(){var audio=document.getElementById("audio");audio.src="audio/kanong.mp3";audio.loop=true;playCotrol()}function clicks(){var audio=document.getElementById("audio");$("#control").click(function(){if($("#control").hasClass("play")){$("#control").addClass("pause").removeClass("play");audio.play()}else{$("#control").addClass("play").removeClass("pause");audio.pause()}})}function playCotrol(){audio.addEventListener("loadeddata",function(){$("#control").addClass("play").removeClass("color_gray");clicks()},false);audio.addEventListener("pause",function(){$("#control").addClass("play").removeClass("player-item-play")},false);audio.addEventListener("playing",function(){$("#control").addClass("player-item-play").removeClass("play");var mark=$(".page-mark");if(!mark.hasClass("hide")){mark.addClass("hide");Main.updateView(Main.myScroll.currentPage.pageY)}},false)}},init:function(){$(".main").height($("body").height());this.page=$(".main .flex-1");this.page.height($("body").height());this.bindEvent();this.play();this.makeBg();this.sendMessage()}};window.addEventListener("load",function(){$("body").removeClass("loading");Main.init()},false);